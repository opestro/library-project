<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="description" content="تصفح الوثائق - المكتبة التاريخية الرقمية">
  <meta name="theme-color" content="#007AFF">
  <title>تصفح الوثائق - المكتبة التاريخية الرقمية</title>
  <link rel="stylesheet" href="../styles/global.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Browse specific styles */
    .browse-container {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      background-color: var(--bg-secondary);
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .filter-group {
      flex: 1;
      min-width: 200px;
    }

    .filter-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .filter-group select {
      width: 100%;
      padding: 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border-color);
      background-color: var(--bg-primary);
      font-family: inherit;
    }

    .documents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    .document-card {
      display: flex;
      flex-direction: column;
      background-color: var(--bg-secondary);
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .document-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }

    .document-thumbnail {
      height: 200px;
      background-color: var(--bg-tertiary);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .document-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .document-thumbnail .no-image {
      font-size: 3rem;
      color: var(--text-secondary);
    }

    .document-info {
      padding: 1.5rem;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .document-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .document-meta {
      margin-bottom: 1rem;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .document-meta span {
      display: inline-block;
      margin-left: 0.75rem;
    }

    .document-summary {
      margin-bottom: 1rem;
      color: var(--text-primary);
      flex-grow: 1;
    }

    .document-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
    }

    .view-count {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .document-link {
      display: inline-block;
      background-color: var(--primary-color);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      text-decoration: none;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }

    .document-link:hover {
      background-color: var(--primary-dark);
    }

    .age-section {
      margin-bottom: 3rem;
    }

    .age-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 0.5rem;
    }

    .loading-indicator, .empty-state {
      text-align: center;
      padding: 2rem;
      background-color: var(--bg-secondary);
      border-radius: 1rem;
      margin: 2rem 0;
    }

    .loading-spinner {
      font-size: 2rem;
      color: var(--primary-color);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      margin-top: 2rem;
    }

    .pagination button {
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .pagination button:hover:not(:disabled) {
      background-color: var(--bg-tertiary);
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination span {
      padding: 0.5rem 1rem;
    }
  </style>
</head>
<body>
  <!-- Skip to main content for accessibility -->
  <a href="#main-content" class="sr-only">تخطي إلى المحتوى الرئيسي</a>

  <!-- Navigation -->
  <header>
    <div class="container">
      <nav class="nav" id="main-nav">
        <div class="nav-logo">
          <a href="../../index.html">
            <i class="fas fa-book-open"></i>
            المكتبة التاريخية
          </a>
        </div>
        <ul class="nav-links" id="menu">
          <li><a href="../../index.html">الرئيسية</a></li>
          <li><a href="browse.html" class="active">تصفح الوثائق</a></li>
          <li><a href="request.html">طلب وثائق</a></li>
          <li><a href="../../index.html#contact">اتصل بنا</a></li>
        </ul>
        <div class="nav-actions">
          <button class="btn-icon" id="dark-mode-toggle" aria-label="تغيير الوضع المظلم">
            <i class="fas fa-moon"></i>
          </button>
          <a href="login.html" id="login-button" class="btn btn-outline">
            <i class="fas fa-sign-in-alt"></i>
            تسجيل الدخول
          </a>
          <div id="user-menu" style="display:none;" class="user-dropdown">
            <button class="btn btn-icon user-dropdown-trigger">
              <i class="fas fa-user-circle"></i>
              <span id="username">المستخدم</span>
            </button>
            <div class="dropdown-menu">
              <a href="profile.html">
                <i class="fas fa-user"></i>
                الملف الشخصي
              </a>
              <a href="create-post.html">
                <i class="fas fa-plus"></i>
                إضافة وثيقة
              </a>
              <button id="logout-button" class="dropdown-item">
                <i class="fas fa-sign-out-alt"></i>
                تسجيل الخروج
              </button>
            </div>
          </div>
          <button class="nav-menu-btn" aria-expanded="false" aria-label="فتح القائمة" aria-controls="menu">
            <i class="fas fa-bars"></i>
          </button>
        </div>
      </nav>
    </div>
  </header>

  <main id="main-content">
    <section class="section">
      <div class="container">
        <h1 class="section-title">تصفح <span>الوثائق</span></h1>
        
        <div class="browse-container">
          <!-- Filters -->
          <div class="filters">
            <div class="filter-group">
              <label for="age-filter">العصر التاريخي</label>
              <select id="age-filter">
                <option value="">كل العصور</option>
                <!-- Will be populated dynamically -->
              </select>
            </div>
            
            <div class="filter-group">
              <label for="category-filter">التصنيف</label>
              <select id="category-filter">
                <option value="">كل التصنيفات</option>
                <!-- Will be populated dynamically -->
              </select>
            </div>
          </div>

          <!-- Loading Indicator -->
          <div id="loading-indicator" class="loading-indicator">
            <i class="fas fa-spinner loading-spinner"></i>
            <p>جاري تحميل الوثائق...</p>
          </div>

          <!-- Documents Container -->
          <div id="documents-container" style="display: none;">
            <!-- Ages sections will be populated here -->
          </div>

          <!-- Empty State -->
          <div id="empty-state" class="empty-state" style="display: none;">
            <i class="fas fa-search fa-3x"></i>
            <h3>لا توجد وثائق متطابقة</h3>
            <p>حاول تغيير معايير البحث للعثور على وثائق أخرى.</p>
          </div>

          <!-- Pagination -->
          <div class="pagination">
            <button id="prev-page" disabled>السابق</button>
            <span id="pagination-info">صفحة 1 من 1</span>
            <button id="next-page" disabled>التالي</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-brand">
          <h3 class="footer-heading">
            <i class="fas fa-book-open"></i>
            المكتبة التاريخية
          </h3>
          <p>المكتبة التاريخية الرقمية هي مشروع يهدف إلى توثيق وحماية الوثائق التاريخية وعرضها بشكل رقمي مع ضمان أمانها وأصالتها.</p>
        </div>
        
        <div class="footer-links-wrapper">
          <div>
            <h3 class="footer-heading">روابط سريعة</h3>
            <ul class="footer-links">
              <li><a href="../../index.html" class="footer-link">الرئيسية</a></li>
              <li><a href="browse.html" class="footer-link">تصفح الوثائق</a></li>
              <li><a href="request.html" class="footer-link">طلب وثائق</a></li>
              <li><a href="../../index.html#contact" class="footer-link">اتصل بنا</a></li>
            </ul>
          </div>
          
          <div>
            <h3 class="footer-heading">الخدمات</h3>
            <ul class="footer-links">
              <li><a href="browse.html" class="footer-link">البحث في الوثائق</a></li>
              <li><a href="request.html" class="footer-link">طلب وثائق خاصة</a></li>
              <li><a href="#" class="footer-link">البحث العلمي</a></li>
            </ul>
          </div>
        </div>
      </div>
      
      <div class="copyright">
        <p>© ٢٠٢٣ المكتبة التاريخية الرقمية. جميع الحقوق محفوظة.</p>
      </div>
    </div>
  </footer>

  <!-- JavaScript -->
  <script type="module">
    import { isAuthenticated, getCurrentUser, logout, getHistoricalAges, getCategories, getDocuments, getFileUrl } from '../js/pocketbase.js';
    
    document.addEventListener('DOMContentLoaded', async function() {
      // Check authentication and update UI
      updateAuthUI();
      
      // Initialize filters
      await initializeFilters();
      
      // Load initial documents
      loadDocuments();
      
      // Event listeners
      document.getElementById('age-filter').addEventListener('change', loadDocuments);
      document.getElementById('category-filter').addEventListener('change', loadDocuments);
      document.getElementById('prev-page').addEventListener('click', () => changePage(-1));
      document.getElementById('next-page').addEventListener('click', () => changePage(1));
      
      // Logout button
      const logoutButton = document.getElementById('logout-button');
      if (logoutButton) {
        logoutButton.addEventListener('click', function() {
          logout();
          window.location.reload();
        });
      }
      
      // Mobile menu functionality
      const menuBtn = document.querySelector('.nav-menu-btn');
      const navLinks = document.querySelector('.nav-links');
      
      if (menuBtn && navLinks) {
        menuBtn.addEventListener('click', function() {
          navLinks.classList.toggle('active');
          const isExpanded = menuBtn.getAttribute('aria-expanded') === 'true';
          menuBtn.setAttribute('aria-expanded', !isExpanded);
          menuBtn.innerHTML = isExpanded ? '<i class="fas fa-bars"></i>' : '<i class="fas fa-times"></i>';
        });
      }
      
      // Dark mode toggle
      const darkModeToggle = document.getElementById('dark-mode-toggle');
      const isDarkMode = localStorage.getItem('darkMode') === 'true';
      
      if (isDarkMode) {
        document.body.classList.add('dark-mode');
        darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
      }
      
      darkModeToggle.addEventListener('click', function() {
        document.body.classList.toggle('dark-mode');
        const isCurrentlyDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('darkMode', isCurrentlyDark);
        darkModeToggle.innerHTML = isCurrentlyDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
      });
    });
    
    // Update UI based on authentication status
    function updateAuthUI() {
      const loginButton = document.getElementById('login-button');
      const userMenu = document.getElementById('user-menu');
      const username = document.getElementById('username');
      
      if (isAuthenticated()) {
        const user = getCurrentUser();
        
        if (loginButton) loginButton.style.display = 'none';
        if (userMenu) {
          userMenu.style.display = 'block';
          if (username && user) {
            username.textContent = user.name || 'المستخدم';
          }
        }
      } else {
        if (loginButton) loginButton.style.display = 'block';
        if (userMenu) userMenu.style.display = 'none';
      }
    }
    
    // Initialize filters with data from PocketBase
    async function initializeFilters() {
      try {
        // Load ages
        const ages = await getHistoricalAges();
        const ageFilter = document.getElementById('age-filter');
        
        ages.forEach(age => {
          const option = document.createElement('option');
          option.value = age.id;
          option.textContent = age.name;
          ageFilter.appendChild(option);
        });
        
        // Load categories
        const categories = await getCategories();
        const categoryFilter = document.getElementById('category-filter');
        
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category.id;
          option.textContent = category.name;
          categoryFilter.appendChild(option);
        });
      } catch (error) {
        console.error('Error initializing filters:', error);
      }
    }

    // Current pagination state
    let currentPage = 1;
    let totalPages = 1;
    const perPage = 12;
    
    // Load documents based on current filters
    async function loadDocuments() {
      try {
        // Show loading indicator
        document.getElementById('loading-indicator').style.display = 'block';
        document.getElementById('documents-container').style.display = 'none';
        document.getElementById('empty-state').style.display = 'none';
        
        // Get filter values
        const ageId = document.getElementById('age-filter').value;
        const categoryId = document.getElementById('category-filter').value;
        
        // Create filters object
        const filters = {};
        if (ageId) filters.ageId = ageId;
        if (categoryId) filters.categoryId = categoryId;
        
        // Fetch documents
        const result = await getDocuments(filters, currentPage, perPage);
        
        // Update pagination
        totalPages = Math.ceil(result.totalItems / perPage);
        updatePagination();
        
        // Check if there are documents
        if (!result.items || result.items.length === 0) {
          document.getElementById('empty-state').style.display = 'block';
          document.getElementById('loading-indicator').style.display = 'none';
          return;
        }
        
        // Group documents by age
        const documentsByAge = {};
        const ages = {};
        
        result.items.forEach(doc => {
          const ageId = doc.age;
          const ageName = doc.expand?.age?.name || 'أخرى';
          
          if (!documentsByAge[ageId]) {
            documentsByAge[ageId] = [];
            ages[ageId] = ageName;
          }
          
          documentsByAge[ageId].push(doc);
        });
        
        // Create HTML for documents
        const container = document.getElementById('documents-container');
        container.innerHTML = '';
        
        Object.keys(documentsByAge).forEach(ageId => {
          const ageName = ages[ageId];
          const documents = documentsByAge[ageId];
          
          const ageSection = document.createElement('div');
          ageSection.className = 'age-section';
          ageSection.innerHTML = `
            <h2 class="age-title">${ageName}</h2>
            <div class="documents-grid">
              ${documents.map(doc => createDocumentCard(doc)).join('')}
            </div>
          `;
          
          container.appendChild(ageSection);
        });
        
        // Hide loading, show documents
        document.getElementById('loading-indicator').style.display = 'none';
        document.getElementById('documents-container').style.display = 'block';
      } catch (error) {
        console.error('Error loading documents:', error);
        document.getElementById('loading-indicator').style.display = 'none';
        document.getElementById('empty-state').style.display = 'block';
      }
    }
    
    // Create HTML for a document card
    function createDocumentCard(document) {
      // Get thumbnail from media if available
      let thumbnailHtml = `<div class="no-image"><i class="fas fa-file-alt"></i></div>`;
      
      // Format the summary (limit to 100 chars)
      const summary = document.summary 
        ? (document.summary.length > 100 ? document.summary.substring(0, 100) + '...' : document.summary)
        : 'لا يوجد ملخص';
      
      // Get category and age names
      const categoryName = document.expand?.category?.name || 'غير مصنف';
      const ageName = document.expand?.age?.name || 'غير محدد';
      
      // Format date
      const publishDate = document.published_at 
        ? new Date(document.published_at).toLocaleDateString('ar-EG')
        : new Date(document.created).toLocaleDateString('ar-EG');
      
      return `
        <div class="document-card">
          <div class="document-thumbnail">
            ${thumbnailHtml}
          </div>
          <div class="document-info">
            <h3 class="document-title">${document.title}</h3>
            <div class="document-meta">
              <span><i class="fas fa-layer-group"></i> ${categoryName}</span>
              <span><i class="fas fa-clock"></i> ${ageName}</span>
            </div>
            <p class="document-summary">${summary}</p>
            <div class="document-footer">
              <div class="view-count">
                <i class="fas fa-eye"></i> ${document.view_count || 0} مشاهدة
              </div>
              <a href="document.html?id=${document.id}" class="document-link">عرض الوثيقة</a>
            </div>
          </div>
        </div>
      `;
    }
    
    // Update pagination UI
    function updatePagination() {
      const prevButton = document.getElementById('prev-page');
      const nextButton = document.getElementById('next-page');
      const paginationInfo = document.getElementById('pagination-info');
      
      prevButton.disabled = currentPage <= 1;
      nextButton.disabled = currentPage >= totalPages;
      
      paginationInfo.textContent = `صفحة ${currentPage} من ${totalPages}`;
    }
    
    // Change page
    function changePage(delta) {
      const newPage = currentPage + delta;
      
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        loadDocuments();
        // Scroll to top of the documents container
        document.getElementById('documents-container').scrollIntoView({ behavior: 'smooth' });
      }
    }
  </script>
</body>
</html> 